<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EX SHOOTER - By Iyan Aliman</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; text-shadow: 0 0 8px #00ffcc; pointer-events: none; z-index: 10; }
        .stat { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 1px solid #ff00ff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: rgba(0,0,0,0.95); color: white; z-index: 20; text-align: center; border: 4px double #00ffcc; box-sizing: border-box; 
        }
        h1 { font-size: 70px; margin: 0; color: #ff00ff; text-shadow: 0 0 20px #ff00ff; letter-spacing: 5px; }
        h2 { font-size: 20px; color: #00ffcc; margin-top: -10px; margin-bottom: 30px; opacity: 0.8; }
        
        .btn { background: transparent; border: 2px solid #00ffcc; color: #00ffcc; padding: 15px 30px; font-size: 18px; cursor: pointer; transition: 0.3s; margin: 10px; text-transform: uppercase; }
        .btn:hover { background: #00ffcc; color: black; box-shadow: 0 0 20px #00ffcc; }
        #file-input { display: none; }
        #results, #pause-ui { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">SCORE: <span id="score">0</span></div>
        <div class="stat">TIME: <span id="timer">60</span>s</div>
        <div class="stat">ACCURACY: <span id="accuracy">100</span>%</div>
    </div>
    <div id="crosshair"></div>

    <div id="overlay">
        <div id="menu">
            <div id="main-header">
                <h1>EX SHOOTER</h1>
                <h2>By Iyan Aliman</h2>
            </div>
            <div id="pause-ui">
                <h1 style="color: #00ffcc;">PAUSED</h1>
                <p>Training Suspended</p>
            </div>
            
            <button class="btn" id="start-btn">Start Training</button><br>
            <div id="upload-section">
                <label for="file-input" class="btn">Upload Custom Target</label>
                <input type="file" id="file-input" accept="image/*">
            </div>
        </div>
        
        <div id="results">
            <h1>GAME OVER</h1>
            <p id="final-stats" style="font-size: 24px; color: #00ffcc;"></p>
            <button class="btn" onclick="location.reload()">Restart</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        let targetTex = new THREE.TextureLoader().load('./target.png'); 
        let score = 0, fired = 0, hits = 0, timeLeft = 60, gameActive = false, timerStarted = false;
        const targets = [];
        const particles = [];
        const gunGroup = new THREE.Group();

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        scene.add(new THREE.GridHelper(200, 50, 0xff00ff, 0x222222));

        function createGun() {
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            const neonMat = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 2 });
            const barrel = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 1), bodyMat);
            const grip = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.5, 0.2), bodyMat);
            grip.position.set(0, -0.3, 0.3);
            const sight = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.1, 0.4), neonMat);
            sight.position.set(0, 0.2, 0);
            gunGroup.add(barrel, grip, sight);
            gunGroup.position.set(0.5, -0.4, -0.8); 
            camera.add(gunGroup);
            scene.add(camera);
        }
        createGun();

        function createExplosion(pos) {
            for (let i = 0; i < 20; i++) {
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 0.15), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
                p.position.copy(pos);
                // Increased particle speed
                p.userData.velocity = new THREE.Vector3((Math.random()-0.5)*0.5, (Math.random()-0.5)*0.5, (Math.random()-0.5)*0.5);
                p.userData.life = 1.0;
                scene.add(p);
                particles.push(p);
            }
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                targetTex = new THREE.TextureLoader().load(URL.createObjectURL(file));
                alert("Target Ready!");
            }
        });

        const controls = new PointerLockControls(camera, document.body);
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('overlay');
        const pauseUI = document.getElementById('pause-ui');
        const mainHeader = document.getElementById('main-header');
        const uploadSection = document.getElementById('upload-section');

        startBtn.addEventListener('click', () => controls.lock());

        controls.addEventListener('lock', () => {
            overlay.style.display = 'none';
            if (!timerStarted) {
                gameActive = true;
                timerStarted = true;
                startTimer();
            }
        });

        controls.addEventListener('unlock', () => {
            if (timeLeft > 0) {
                overlay.style.display = 'flex';
                mainHeader.style.display = 'none';
                uploadSection.style.display = 'none';
                pauseUI.style.display = 'block';
                startBtn.innerText = "Resume Training";
            }
        });

        function startTimer() {
            const itv = setInterval(() => {
                if (controls.isLocked && timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').innerText = timeLeft;
                }
                if (timeLeft <= 0) {
                    clearInterval(itv);
                    gameActive = false;
                    controls.unlock();
                    overlay.style.display = 'flex';
                    document.getElementById('menu').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('final-stats').innerText = `Score: ${score} | Acc: ${Math.round((hits/(fired||1))*100)}%`;
                }
            }, 1000);
        }

        function createTarget() {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(2.5, 2.5, 0.1), new THREE.MeshStandardMaterial({ map: targetTex, transparent: true }));
            mesh.position.set((Math.random()-0.5)*40, Math.random()*6+1, -Math.random()*30-5);
            scene.add(mesh);
            targets.push(mesh);
        }

        window.addEventListener('mousedown', () => {
            if (!controls.isLocked || !gameActive) return;
            fired++;
            gunGroup.position.z += 0.2;
            setTimeout(() => gunGroup.position.z -= 0.2, 50);

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(targets);
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                createExplosion(obj.position);
                scene.remove(obj);
                targets.splice(targets.indexOf(obj), 1);
                score += 100; hits++;
                createTarget();
            }
            document.getElementById('score').innerText = score;
            document.getElementById('accuracy').innerText = Math.round((hits/fired)*100);
        });

        const keys = { w: false, a: false, s: false, d: false };
        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (controls.isLocked && gameActive) {
                if (keys.w) controls.moveForward(0.15);
                if (keys.s) controls.moveForward(-0.15);
                if (keys.a) controls.moveRight(-0.15);
                if (keys.d) controls.moveRight(0.15);
                targets.forEach(t => t.lookAt(camera.position));
            }

            // Corrected Particle Loop
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.position.add(p.userData.velocity);
                p.userData.life -= delta;
                if (p.userData.life <= 0) {
                    scene.remove(p);
                    particles.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        for(let i=0; i<10; i++) createTarget();
        camera.position.y = 1.6;
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

